#### THIS PROJECT IS STILL BEING BUILT ####


# backtestkit

A deterministic historical backtesting engine with a modular signal generator, built in Python.
This will be later used on signals generated by Machine Learning powered strategies.

## What it does

backtestkit simulates trading strategies against historical OHLC data. It is completely strategy-agnostic — any strategy that produces a list of `Signal` objects can plug straight into the engine without any engine modifications.

**Core principles:**
- No lookahead bias — signals at candle `i` execute at the open of candle `i+1`
- Fully deterministic — identical input always produces identical output
- Worst-case assumptions — if both SL and TP trigger on the same candle, SL fires
- Rule-based — no hidden logic or implicit behavior

## Project structure

```
backtestkit/
├── backtester/
│   ├── engine.py              # Main simulation loop
│   ├── execution_modes.py     # Price resolution (spread/fee models)
│   ├── portfolio.py           # Capital accounting
│   ├── sl_tp.py               # Stop loss / take profit engine
│   ├── metrics.py             # Performance calculations
│   └── visualization.py       # Charts (matplotlib)
├── strategies/
│   ├── base_strategy.py       # Abstract interface
│   ├── ma_crossover.py        # MA Crossover strategy
│   └── signals.py             # Signal dataclass
├── common/
│   ├── models.py              # Shared enums (ExecutionMode, SignalType)
│   └── data_loader.py         # CSV loader + OHLC resampler
├── data/
│   └── nas100_m1_mid_test.csv # NAS100 1-minute test data
├── context/                   # Spec, plan, and test documentation
├── summaries/                 # Phase completion notes
├── tests/                     # Automated (pytest) + manual tests
└── run_backtest.py            # CLI entry point (in progress)
```

## Execution modes

| Mode | Description |
|---|---|
| `SPREAD_ON` | Realistic: buy at ask, sell at bid (`mid ± spread/2`) |
| `SPREAD_OFF` | Fee-based: execute at mid, 0.1% fee on entry and exit |
| `STATIC_SPREAD` | Same as SPREAD_ON but with a user-defined constant spread |

## Strategies

### MA Crossover (implemented)

Generates LONG/SHORT signals based on fast and slow simple moving average crossovers.

- Fast MA crosses above slow MA → LONG
- Fast MA crosses below slow MA → SHORT
- On reversal: emits `CLOSE(size=1.0)` + new direction at the same candle

**Parameters:** `fast_period`, `slow_period`, `sl_pct`, `tp_pct`

### Adding a new strategy

Extend `BaseStrategy` and implement `generate(df) -> List[Signal]`. Drop it in `strategies/`. The engine needs zero changes.

## Installation

```bash
pip install -r requirements.txt
```

Or with dev dependencies:

```bash
pip install -e ".[dev]"
```

**Requirements:** Python 3.10+, pandas, numpy, matplotlib, pytest

## Running tests

```bash
pytest tests/ -v
```

Run a specific phase:

```bash
pytest tests/test_data_loader.py -v      # Phase 1 — data layer
pytest tests/test_strategy.py -v         # Phase 2 — signal generator
pytest tests/test_execution_modes.py -v  # Phase 3 — execution modes
pytest tests/test_portfolio.py -v        # Phase 4 — capital accounting
pytest tests/test_sl_tp.py -v            # Phase 5 — SL/TP engine
pytest tests/test_engine.py -v           # Phase 6 — main loop
```

## Current progress

| Phase | Description | Status |
|---|---|---|
| 1 | Data layer (CSV loader, resampler) | Done |
| 2 | MA Crossover strategy + signals | Done |
| 3 | Execution modes (price resolution) | Done |
| 4 | Portfolio / capital accounting | Done |
| 5 | SL/TP engine | In progress |
| 6 | Main engine loop | In progress |
| 7 | Console logging | Planned |
| 8 | Performance metrics | Planned |
| 9 | Visualization | Planned |
| 10 | CLI runner (`run_backtest.py`) | Planned |
| 11 | Validation & hardening | Planned |
